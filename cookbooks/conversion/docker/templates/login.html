<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Setting Session</title>
    <script>
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }

        function getBrowserDebugInfo() {
            try {
                return {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    platform: navigator.platform,
                    screenWidth: window.screen.width,
                    screenHeight: window.screen.height,
                    colorDepth: window.screen.colorDepth,
                    pixelDepth: window.screen.pixelDepth,
                    timezoneOffset: new Date().getTimezoneOffset(),
                    currentTime: new Date().toString(),
                    cookiesEnabled: navigator.cookieEnabled,
                    javaEnabled: navigator.javaEnabled ? navigator.javaEnabled() : 'Not available'
                };
            } catch (error) {
                console.error("Failed to get browser debug info:", error);
                // Return a fallback or partial object in case of an error
                return {};
            }
        }

        function postData(url = '', data = {}) {
            return fetch(url, {
                method: 'POST',
                mode: 'cors',
                cache: 'no-cache',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json'
                },
                redirect: 'follow',
                referrerPolicy: 'no-referrer',
                body: JSON.stringify(data)
            }).then(response => response.json()); // Expecting a JSON response
        }

        function collectAndSendData() {
            fetch('https://api.ipify.org?format=json')
                .then(results => results.json())
                .catch(() => {
                    console.error("Failed to fetch IP address, proceeding without it.");
                    return { ip: "Unavailable" }; // Fallback or partial content
                })
                .then(ipData => {
                    const debugInfo = getBrowserDebugInfo();
                    const dataToSend = {
                        ...debugInfo,
                        publicIP: ipData.ip
                    };

                    postData('/login', dataToSend)
                        .then(response => {
                            if (response.success && response.cookieValue && response.redirectUrl) {
                                // Set cookie as instructed by the server
                                setCookie("uuid", response.cookieValue, 7); // Example: Set for 7 days
                                // Redirect to the URL provided by the server
                                window.location.href = response.redirectUrl;
                            } else {
                                console.error("Failed to process data on the server.");
                            }
                        })
                        .catch(error => console.error("Error sending data:", error));
                });
        }

        window.onload = collectAndSendData;
    </script>
</head>
<body>
    <!-- No visible content needed as the page will perform actions via JavaScript -->
</body>
</html>
